<html>
<head>
<title>Invasive species annotation tool</title>
</head>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous">

    <style>
        div {
            margin: 5px;
        }
        select {
            vertical-align: top;
        }
    </style>

<body>
	<div>
		<a href="index.html">Back to index</a>
	</div>

	Click the button to get 10 random candidates:
	<input type="button" value="Get 10 random candidates"
		onclick="getCandidates()" />


	<div id="boundingboxes"></div>

	<script type="text/javascript">
	    var xobjSpecies = new XMLHttpRequest();
	    xobjSpecies.open('GET', '/getAllSpecies', false); //synchronous call
	    xobjSpecies.send();
	    speciesJson = JSON.parse(xobjSpecies.responseText);
	
	    var speciesIdMap = {};
	
	    speciesJson.forEach(function (species) {
	        speciesIdMap[species.speciesId] = species.description;
	    });
		function getCandidates() {
			document.getElementById("boundingboxes").innerHTML = "";
			var xobj = new XMLHttpRequest();
			xobj.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var panosJson = JSON.parse(this.responseText);
					panosJson.forEach(function(pano) {
						var img = new Image();
						img.src = "pano_images/z5/" + pano['panoramaId']
								+ '_z5.jpg';
						img.onload = function() {
							var bb = pano.boundingBoxes[0];
							var startX = bb.topLeftX*4;
							var startY = bb.topLeftY*4;
							var endX = bb.bottomRightX*4;
							var endY = bb.bottomRightY*4;
							// display bounding box image
							var newimg = document
									.createElement("canvas");
							newimg.width = endX - startX;
							newimg.height = endY - startY;
							var newctx = newimg.getContext('2d');
							newctx.drawImage(img, startX, // where to start clipping
							startY, // where to start clipping
							endX - startX, // width
							endY - startY, // height
							0, // where to place image on canvas
							0, // where to place image on canvas
							endX - startX, // width
							endY - startY); // height
							var div = document.createElement("div");
							div.id = "bb"+bb.boxId;
				            div.style.border="solid";
				            div.style.borderColor="gray";
				            div.style.padding="5px";
				            div.style.margin ="5px";

							div.appendChild(newimg);
							div.appendChild(document.createElement("br"));
				            
				            var spanLabel = document.createElement("span");
				            spanLabel.innerHTML = "Candidate label: " +speciesIdMap[bb.speciesId] +" ";
				            spanLabel.style.verticalAlign="top";
							div.appendChild(spanLabel);
							
							var confirmButton = document.createElement("input");
							confirmButton.id = "confirmBtn"+bb.boxId;
							confirmButton.type="button";
							confirmButton.value="Confirm";
							confirmButton.style.verticalAlign="top";
							confirmButton.onclick = function() {
								document.getElementById("confirmBtn"+bb.boxId).disabled=true;
								document.getElementById("rejectBtn"+bb.boxId).disabled=true;
								var xobjConfirm = new XMLHttpRequest();
								xobjConfirm.onreadystatechange = function() {
									if( this.readyState == 4 && this.status == 200 ) {
										document.getElementById("bb"+bb.boxId).append(" Confirmed");
										confirmButton.disabled=true;
										document.getElementById("rejectBtn"+bb.boxId).disabled=true;
									}
								}
								xobjConfirm.open("post", "/confirmCandidate", true);
								xobjConfirm.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
								xobjConfirm.send("boxId="+bb.boxId);
							}
							div.appendChild(confirmButton);
							
							var rejectButton = document.createElement("input");
							rejectButton.id = "rejectBtn"+bb.boxId;
							rejectButton.type="button";
							rejectButton.value="Reject";
							rejectButton.style.verticalAlign="top";
							rejectButton.onclick = function() {
								document.getElementById("confirmBtn"+bb.boxId).disabled=true;
								document.getElementById("rejectBtn"+bb.boxId).disabled=true;
								var xobjReject = new XMLHttpRequest();
								xobjReject.onreadystatechange = function() {
									if( this.readyState == 4 && this.status == 200 ) {
										document.getElementById("bb"+bb.boxId).append(" Rejected");
										rejectButton.disabled=true;
										document.getElementById("confirmBtn"+bb.boxId).disabled=true;
									}
								}
								xobjReject.open("post", "/rejectCandidate", true);
								xobjReject.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
								xobjReject.send("boxId="+bb.boxId);
							}
							div.appendChild(rejectButton);
							
							div.appendChild(document.createElement("br"));
							var editPanoLink = document.createElement('a');
							editPanoLink.href="editPanorama.html?panoramaId="+pano.panoramaId+"#"+bb.boxId;
							editPanoLink.target="_blank";
							editPanoLink.innerHTML="View panorama";
							div.appendChild(editPanoLink);
							
							document.getElementById("boundingboxes")
									.appendChild(div);
						}
					});
				}
			};
                        var rseed = Math.floor((Math.random() * 10000000) + 1);
			xobj.open('GET', '/getCandidates?rseed='+rseed, true);
			xobj.send();
		}
	</script>

</body>
</html>
