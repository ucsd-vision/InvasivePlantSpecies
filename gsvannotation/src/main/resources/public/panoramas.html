<html>
<head>
    <title>Invasive species annotation tool</title>
</head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<body>
<a href="index.html">Back to index</a>
<div>
    <h2>Add GSV panorama for annotation</h2>
    <!--Enter a Google Street View URL: <input type="text" id="gsvUrl" /><input type="button" id="gsvUrlGo" value="go" /><br />-->

    Enter a GPS coordinates Lat: <input type="text" id="gsvLat" width="8"/> Lng: <input type="text" id="gsvLng"
                                                                                        width="8"/><input type="button"
                                                                                                          id="latlngGo"
                                                                                                          value="go"
                                                                                                          onclick="latlng2pano()"/><span
        id="latlngStatus"></span>
</div>
<div>
    <h2>Existing panos</h2>
    Filter by Species:
    <select id="speciesFilter">
        <option value="-1">All</option>
    </select>

    <table id="bbtable" border="1" cellspacing=0 cellpadding=0>
        <thead>
        <tr>
            <th>Pano Id</th>
            <th>Lat,Lng</th>
            <th>Description</th>
            <th>Region</th>
            <th>Country</th>
            <th>Bounding Boxes</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

</div>
</body>
<script type="text/javascript">

var speciesJson;
var speciesToDisplay = -1;
var xobjSpecies = new XMLHttpRequest();
xobjSpecies.open('GET', '/getAllSpecies', false); //synchronous call
xobjSpecies.send();
speciesJson = JSON.parse(xobjSpecies.responseText);

var speciesIdMap = {};

speciesJson.forEach( function( species ) {
    speciesIdMap[species.speciesId] = species.description;
});

var speciesDropdown = document.getElementById("speciesFilter");
  	speciesDropdown.onchange=function( e ) {
  	   speciesToDisplay = speciesDropdown.value;
  	   clearPanos();
       displayPanos();
  	};
	speciesJson.forEach( function( species ) {
		var opt = document.createElement("option");
		opt.value = species.speciesId;
		opt.text = species.description;
		speciesDropdown.options.add(opt);
	});


var xobj = new XMLHttpRequest();
xobj.overrideMimeType("application/json");
xobj.onreadystatechange = function() {
	if( this.readyState == 4 && this.status == 200 ) {
		jsonPanos = JSON.parse(this.responseText);
		displayPanos();
	}
}
xobj.open('GET', '/getAllPanos', true);
xobj.send();

function latlng2pano() {
	var btn = document.getElementById("latlngGo");
	var statusSpan = document.getElementById("latlngStatus");
	statusSpan.innerHTML="Creating...";
	var lat = document.getElementById("gsvLat").value;
	var lng = document.getElementById("gsvLng").value;

	var xobj = new XMLHttpRequest();
	xobj.onreadystatechange = function() {
		if( this.readyState == 4 && this.status == 200 ) {
			if( this.responseText != "" ) {
				var panoramaId = this.responseText;
				window.location.assign("editPanorama.html?panoramaId=" + panoramaId );
			} else {
				btn.disabled=false;
				statusSpan.innerHTML = "Failed to create pano with current lat/lng coordinates";
			}
		}
	};
	xobj.open('GET', '/latlng2pano?lat='+lat+'&lng='+lng, true);
	xobj.send();
}

function displayPanos() {
  jsonPanos.forEach( function( pano ) {
    if(hasSpecies(pano)) {
      var boxes = pano.boundingBoxes;
      var speciesNumber = {};

      boxes.forEach( function( box ) {
          var speciesDescription = speciesIdMap[box.speciesId];
          if (speciesNumber[speciesDescription] == null) {
              speciesNumber[speciesDescription] = 0;
          }
          speciesNumber[speciesDescription]++;
      });

      var boundingBoxString = "Total: " + pano.boundingBoxes.length;

      for (description in speciesNumber) {
          boundingBoxString += "<br/>" + description + ": " + speciesNumber[description];
      }

      var newrow = document.createElement("tr");
      newrow.innerHTML = "<td>"+pano.panoramaId+"</td><td>"+pano.lat + ", " + pano.lng + "</td>"+
      "<td>"+pano.description+"</td>"+
      "<td>"+pano.region+"</td>"+
      "<td>"+pano.country+"</td>"+
      "<td>" + boundingBoxString + "</td>" +
      "<td><a href='editPanorama.html?panoramaId="+pano.panoramaId+"'>edit</a></td>";

    document.getElementById("bbtable").tBodies[0].appendChild(newrow);
    }
  });
}

function clearPanos() {
    var t = document.getElementById("bbtable");
    t.tBodies[0].innerHTML="";
}

function hasSpecies(pano) {
    if (speciesToDisplay == -1) {
         return true;
    }

    var hasSpecies = false;
    var boxes = pano.boundingBoxes;
    boxes.forEach( function( box ) {
        if(box.speciesId == speciesToDisplay){
              hasSpecies = true;
        }
    });

    return hasSpecies;
}
</script>
</html>

